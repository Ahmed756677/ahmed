<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ahmed Abdullah ‚Äî Personal</title>
  <meta name="description" content="An interactive, minimal personal studio for Ahmed Abdullah." />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: {
            brand: {
              50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd',
              400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8',
              800: '#1e40af', 900: '#1e3a8a'
            }
          }
        }
      }
    };
  </script>

  <style>
    html { scroll-behavior: smooth }
    .noise{
      position:absolute; inset:-50%;
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/></filter><rect width='120' height='120' filter='url(%23n)' opacity='0.035'/></svg>");
      animation:noise 2s steps(10) infinite;
      mix-blend-mode:overlay;
      pointer-events:none
    }
    @keyframes noise { 0%{transform:translate3d(0,0,0)} 100%{transform:translate3d(-10%,10%,0)} }
    @keyframes floaty { 0%{transform:translateY(0)} 50%{transform:translateY(-6px)} 100%{transform:translateY(0)} }
    .glass { backdrop-filter:blur(18px) saturate(1.1); background:rgba(255,255,255,.55) }
    .dark .glass { background:rgba(2,6,23,.55) }
    .soft-shadow { box-shadow:0 10px 30px rgba(2,6,23,.20), 0 6px 18px rgba(2,6,23,.18) }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-100 overflow-x-hidden">
  <!-- Interactive constellation background -->
  <canvas id="bg" class="fixed inset-0 -z-20"></canvas>
  <div class="noise fixed pointer-events-none -z-10"></div>
  <!-- Background mini-game HUD -->
  <div id="gameHud"
    class="fixed bottom-4 left-4 z-20 hidden items-center gap-2 rounded-full border border-slate-200/40 dark:border-slate-700/50 px-3 py-1 text-xs bg-white/40 dark:bg-slate-900/40 backdrop-blur-md soft-shadow">
    <span id="gameStatus" class="opacity-80">Game</span>
    <span class="opacity-30">‚Ä¢</span>
    <span id="gameTime" class="tabular-nums">60.0s</span>
    <span class="opacity-30">‚Ä¢</span>
    <span id="gameScore" class="tabular-nums">0</span>
    <span class="opacity-30">‚Ä¢</span>
    <span id="gameBest" class="tabular-nums opacity-80">Best 0</span>
  </div>


  <!-- Header -->
  <header class="absolute top-0 inset-x-0 p-4 sm:p-6 flex items-center justify-between">
    <button id="themeToggle"
      class="inline-flex items-center justify-center w-10 h-10 rounded-full border border-slate-300/70 dark:border-slate-700/70 bg-white/70 dark:bg-slate-900/60 backdrop-blur-md soft-shadow hover:scale-[1.03] transition"
      aria-label="Toggle theme">
      <svg id="iconSun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5" fill="currentColor">
        <path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm0-16a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1Zm0 18a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1Zm10-8a1 1 0 0 1-1 1h-1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1ZM4 12a1 1 0 0 1-1 1H2a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1Zm13.66 6.66a1 1 0 0 1-1.41 0l-.71-.7a1 1 0 1 1 1.41-1.42l.71.71a1 1 0 0 1 0 1.41Zm-10.6-10.6a1 1 0 0 1-1.42 0l-.7-.71A1 1 0 0 1 5.38 6l.71.71a1 1 0 0 1 0 1.41Zm10.6-1.41a1 1 0 0 1 0-1.41l.7-.71A1 1 0 1 1 19.4 6.1l-.71.71a1 1 0 0 1-1.41 0Zm-10.6 10.6a1 1 0 0 1 0-1.41l.71-.71a1 1 0 1 1 1.41 1.41l-.71.7a1 1 0 0 1-1.41 0Z"/>
      </svg>
      <svg id="iconMoon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5 hidden" fill="currentColor">
        <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79Z"/>
      </svg>
    </button>
  </header>

  <!-- Hero Card -->
  <main class="min-h-screen grid place-items-center px-6">
    <section id="card"
      class="relative w-full max-w-3xl glass soft-shadow border border-slate-200/70 dark:border-slate-700/70 rounded-3xl p-8 text-center transition-transform will-change-transform animate-[floaty_8s_ease-in-out_infinite]">

      <div class="inline-flex items-center gap-3 rounded-full border border-brand-200/70 dark:border-brand-700/40 px-3 py-1 text-xs bg-white/70 dark:bg-slate-900/60">
        <span class="h-2 w-2 rounded-full bg-brand-600 animate-pulse"></span>
        <span class="opacity-70">Status</span>
        <strong class="font-semibold">Updating</strong>
      </div>

      <h1 class="mt-5 text-4xl sm:text-5xl font-extrabold tracking-tight">Ahmed Abdullah</h1>

      <p class="mt-4 text-lg text-slate-600 dark:text-slate-300">
        What a waste my life would be without all the beautiful mistakes I've made.
      </p>

      <!-- Local time & weather (IP-based) -->
      <div class="mt-6 flex justify-center">
        <div id="localPill"
          class="hidden items-center gap-2 rounded-full border border-slate-200/70 dark:border-slate-700/50 px-3 py-1 text-xs bg-white/60 dark:bg-slate-900/50">
          <span id="localPlace" class="opacity-80">Locating‚Ä¶</span>
          <span class="opacity-30">‚Ä¢</span>
          <span id="localTime" class="tabular-nums">--:--</span>
          <span class="opacity-30">‚Ä¢</span>
          <span id="localWeather" class="tabular-nums">--¬∞</span>
        </div>
      </div>

      <div class="mt-8 flex flex-wrap justify-center gap-3">
        <a id="contactBtn" href="mailto:Finance@AhmedAbdullah.sa"
          class="group inline-flex items-center gap-2 rounded-2xl border border-slate-300 dark:border-slate-700 px-5 py-3 text-sm font-semibold bg-white/70 dark:bg-slate-900/60 hover:bg-white/90 dark:hover:bg-slate-800 transition">
          <span>Contact</span>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
            class="w-4 h-4 transition-transform group-hover:translate-x-0.5" fill="currentColor">
            <path d="M2 4h20v16H2z" fill="none"/>
            <path d="M22 6v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6m20 0-8.5 6a3 3 0 0 1-3 0L2 6"/>
          </svg>
        </a>

        <button id="copyBtn"
          class="inline-flex items-center gap-2 rounded-2xl bg-brand-600 text-white px-5 py-3 text-sm font-semibold hover:bg-brand-700 transition">
          Copy Email
        </button>
      </div>

      <p class="mt-6 text-[11px] text-slate-500">
        Tip: press
        <kbd class="px-1.5 py-0.5 rounded bg-slate-200/70 dark:bg-slate-800/70">T</kbd>
        to toggle theme. Move your mouse for constellations.
      </p>
    </section>
  </main>

  <script>
    // Everything in one guarded boot so nothing crashes
    document.addEventListener('DOMContentLoaded', () => {
      const root = document.documentElement;

      // Theme init
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const initial = saved ? saved : (prefersDark ? 'dark' : 'light');
      if (initial === 'dark') root.classList.add('dark');

      const btn = document.getElementById('themeToggle');
      const sun = document.getElementById('iconSun');
      const moon = document.getElementById('iconMoon');

      function setTheme(mode) {
        if (mode === 'dark') root.classList.add('dark');
        else root.classList.remove('dark');
        localStorage.setItem('theme', mode);

        const dark = root.classList.contains('dark');
        if (sun && moon) {
          sun.classList.toggle('hidden', dark);
          moon.classList.toggle('hidden', !dark);
        }
      }

      if (btn) btn.addEventListener('click', () =>
        setTheme(root.classList.contains('dark') ? 'light' : 'dark')
      );

      window.addEventListener('keydown', (e) => {
        if (e.key && e.key.toLowerCase() === 't') {
          setTheme(root.classList.contains('dark') ? 'light' : 'dark');
        }
      });

      // Copy email button
      const copyBtn = document.getElementById('copyBtn');
      if (copyBtn) {
        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText('Finance@AhmedAbdullah.sa');
            copyBtn.textContent = 'Copied!';
            setTimeout(() => copyBtn.textContent = 'Copy Email', 1200);
          } catch (_) { /* noop */ }
        });
      }

      // Parallax tilt on the card
      const card = document.getElementById('card');
      if (card) {
        card.addEventListener('mousemove', (e) => {
          const r = card.getBoundingClientRect();
          const x = (e.clientX - r.left) / r.width * 2 - 1;  // -1..1
          const y = (e.clientY - r.top) / r.height * 2 - 1;  // -1..1
          card.style.transform = `rotateX(${(-y * 4).toFixed(2)}deg) rotateY(${(x * 4).toFixed(2)}deg)`;
        });
        card.addEventListener('mouseleave', () => {
          card.style.transform = 'rotateX(0) rotateY(0)';
        });
      }

      // Constellation background (simple, performant)
// Constellation background + mini-game (star collector)
const canvas = document.getElementById('bg');
if (canvas) {
  const ctx = canvas.getContext('2d');

  // HUD
  const gameHud = document.getElementById('gameHud');
  const gameScoreEl = document.getElementById('gameScore');
  const gameBestEl = document.getElementById('gameBest');
  const gameStatusEl = document.getElementById('gameStatus');
  const gameTimeEl = document.getElementById('gameTime');

  let W, H;
  let points = [];
  let mouse = { x: null, y: null };

  // ---- Game state ----
  let gameOn = true; // set to false if you want the game off by default
  let score = 0;
  let best = Number(localStorage.getItem('starBest') || 0); // (old best if you still want it)
  let best60 = Number(localStorage.getItem('starBest60') || 0); // 60-second best
  const ROUND_SECONDS = 60;
  let roundRunning = false;
  let roundEndAtMs = 0;
  let timeLeft = ROUND_SECONDS;
  const BASE_R = 3.6;      // starting size
  const GROWTH = 1.15;     // bigger = faster growth
  const MAX_R  = 28;       // cap so it doesn't become insane


  const player = { x: 0, y: 0, vx: 0, vy: 0, trail: [] };
  let stars = []; // collectibles

  function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    points = createPoints();
    resetGame(true);
  }

  function createPoints() {
    const arr = [];
    const density = Math.min(120, Math.floor((W * H) / 18000));
    for (let i = 0; i < density; i++) {
      arr.push({
        x: Math.random() * W,
        y: Math.random() * H,
        vx: (Math.random() - .5) * 0.4,
        vy: (Math.random() - .5) * 0.4
      });
    }
    return arr;
  }

  function rand(min, max) { return Math.random() * (max - min) + min; }

  function spawnStar() {
    return {
      x: Math.random() * W,
      y: Math.random() * H,
      vx: (Math.random() - 0.5) * 0.25,
      vy: (Math.random() - 0.5) * 0.25,
      r: rand(2.2, 3.4),
      pulse: 0
    };
  }

  function resetGame(keepScore = false) {
    if (!keepScore) score = 0;
    
    best = Number(localStorage.getItem('starBest') || 0);
    best60 = Number(localStorage.getItem('starBest60') || 0);
    
    roundRunning = false;
    timeLeft = ROUND_SECONDS;
    roundEndAtMs = 0;

    player.x = W * 0.5;
    player.y = H * 0.5;
    player.vx = 0;
    player.vy = 0;
    player.trail = [];

    stars = [];
    const n = Math.max(10, Math.min(18, Math.floor((W * H) / 120000)));
    for (let i = 0; i < n; i++) stars.push(spawnStar());

    updateHud();
  }

  function updateHud() {
    best60 = Number(localStorage.getItem('starBest60') || best60);
    if (!gameHud || !gameScoreEl || !gameBestEl || !gameStatusEl) return;
    if (gameOn) {
      gameHud.classList.remove('hidden');
      gameHud.classList.add('inline-flex');
      gameStatusEl.textContent = "Game";
      gameScoreEl.textContent = String(score);
      gameBestEl.textContent = `Best ${best60}`;
      if (gameTimeEl) gameTimeEl.textContent = `${timeLeft.toFixed(1)}s`;
    } else {
      gameHud.classList.add('hidden');
      gameHud.classList.remove('inline-flex');
    }
  }

  function toggleGame() {
    gameOn = !gameOn;
    if (gameOn) resetGame(false);
    updateHud();
  }
  function startRound() {
  roundRunning = true;
  const now = performance.now();
  roundEndAtMs = now + ROUND_SECONDS * 1000;
  timeLeft = ROUND_SECONDS;
  if (gameStatusEl) gameStatusEl.textContent = "GO";
  updateHud();
}

function endRound() {
  roundRunning = false;
  timeLeft = 0;

  if (score > best60) {
    best60 = score;
    localStorage.setItem('starBest60', String(best60));
  }

  if (gameStatusEl) gameStatusEl.textContent = "Time up ‚Äî click";
  updateHud();
}

  // Pointer + touch
  canvas.style.touchAction = 'none';
  window.addEventListener('pointermove', (e) => { mouse.x = e.clientX; mouse.y = e.clientY; });
  window.addEventListener('pointerleave', () => { mouse.x = null; mouse.y = null; });

  // Dash (click/tap)
  window.addEventListener('pointerdown', () => {
    if (!gameOn) return;
  
    // If time is up, restart a fresh 60s run
    if (!roundRunning && timeLeft === 0) {
      resetGame(false);
      startRound();
    }
  
    // If not running yet, first click starts the timer
    if (!roundRunning && timeLeft > 0) {
      startRound();
    }
  
    // Dash (only meaningful when we have a target)
    if (mouse.x == null) return;
  
    const dx = mouse.x - player.x;
    const dy = mouse.y - player.y;
    const d = Math.hypot(dx, dy) || 1;
    const impulse = 6.2;
    player.vx += (dx / d) * impulse;
    player.vy += (dy / d) * impulse;
  });


  // Toggle game with G
  window.addEventListener('keydown', (e) => {
    if (e.key && e.key.toLowerCase() === 'g') toggleGame();
  });

  window.addEventListener('resize', resize);
  resize();

  (function loop() {
    ctx.clearRect(0, 0, W, H);

    const dark = root.classList.contains('dark');

    // ---------- Background constellations ----------
    ctx.fillStyle = dark ? 'rgba(59,130,246,.9)' : 'rgba(30,58,138,.9)';
    ctx.strokeStyle = dark ? 'rgba(148,163,184,.30)' : 'rgba(51,65,85,.30)';

    for (const p of points) {
      p.x += p.vx; p.y += p.vy;
      if (p.x < 0 || p.x > W) p.vx *= -1;
      if (p.y < 0 || p.y > H) p.vy *= -1;

      ctx.beginPath();
      ctx.arc(p.x, p.y, 1.2, 0, Math.PI * 2);
      ctx.fill();
    }

    for (let i = 0; i < points.length; i++) {
      for (let j = i + 1; j < points.length; j++) {
        const a = points[i], b = points[j];
        const dx = a.x - b.x, dy = a.y - b.y;
        const d2 = dx * dx + dy * dy;
        if (d2 < 10000) {
          const alpha = 1 - d2 / 10000;
          ctx.globalAlpha = alpha * 0.8;
          ctx.beginPath();
          ctx.moveTo(a.x, a.y);
          ctx.lineTo(b.x, b.y);
          ctx.stroke();
          ctx.globalAlpha = 1;
        }
      }
    }

    // Mouse force (your original effect)
    if (mouse.x !== null) {
      for (const p of points) {
        const dx = mouse.x - p.x, dy = mouse.y - p.y;
        const d = Math.hypot(dx, dy);
        if (d < 80) {
          p.vx -= dx * 0.0005;
          p.vy -= dy * 0.0005;
        }
      }
    }

    // ---------- Mini-game layer ----------
    if (gameOn) {
      const pr = Math.min(MAX_R, BASE_R + Math.sqrt(score) * GROWTH);
      // Update countdown
    if (roundRunning) {
      const now = performance.now();
      timeLeft = Math.max(0, (roundEndAtMs - now) / 1000);
      if (timeLeft === 0) endRound();
    } else {
      // show full 60s before start
      if (timeLeft > 0) timeLeft = ROUND_SECONDS;
    }
      if (gameTimeEl) gameTimeEl.textContent = `${timeLeft.toFixed(1)}s`;

      // Player follows mouse with inertia
      const targetX = (mouse.x ?? W * 0.5);
      const targetY = (mouse.y ?? H * 0.5);
      const ax = (targetX - player.x) * 0.0022;
      const ay = (targetY - player.y) * 0.0022;

      player.vx += ax;
      player.vy += ay;

      // gentle damping + speed clamp
      player.vx *= 0.93;
      player.vy *= 0.93;
      const speed = Math.hypot(player.vx, player.vy);
      const maxSpeed = Math.max(6, 12 - pr * 0.18);
      if (speed > maxSpeed) {
        player.vx = (player.vx / speed) * maxSpeed;
        player.vy = (player.vy / speed) * maxSpeed;
      }

      player.x += player.vx;
      player.y += player.vy;

      // wrap around edges (feels spacey)
      if (player.x < -20) player.x = W + 20;
      if (player.x > W + 20) player.x = -20;
      if (player.y < -20) player.y = H + 20;
      if (player.y > H + 20) player.y = -20;

      // trail
      player.trail.push({ x: player.x, y: player.y });
      if (player.trail.length > 18) player.trail.shift();

      // stars drift + collect
      for (const s of stars) {
        s.x += s.vx; s.y += s.vy;
        if (s.x < -10) s.x = W + 10;
        if (s.x > W + 10) s.x = -10;
        if (s.y < -10) s.y = H + 10;
        if (s.y > H + 10) s.y = -10;
        if (s.pulse > 0) s.pulse *= 0.86;

        const dx = s.x - player.x;
        const dy = s.y - player.y;
        const d = Math.hypot(dx, dy);

      if (roundRunning && d < (pr + s.r + 8)) {
        score += 1;
        if (score > best) {
          best = score;
          localStorage.setItem('starBest', String(best));
        }
        if (score > best60) {
          // don‚Äôt save best60 live; endRound() will save it once
          best60 = score;
        }
      
        Object.assign(s, spawnStar());
        s.pulse = 1;
        updateHud();
      }


      // render trail (soft)
      ctx.globalAlpha = 0.55;
      ctx.strokeStyle = dark ? 'rgba(96,165,250,.35)' : 'rgba(30,58,138,.28)';
      ctx.beginPath();
      for (let i = 0; i < player.trail.length; i++) {
        const t = player.trail[i];
        if (i === 0) ctx.moveTo(t.x, t.y);
        else ctx.lineTo(t.x, t.y);
      }
      ctx.stroke();
      ctx.globalAlpha = 1;

      // render stars (collectibles)
      for (const s of stars) {
        const glow = 0.7 + (s.pulse || 0);
        ctx.globalAlpha = Math.min(1, glow);
        ctx.fillStyle = dark ? 'rgba(191,219,254,.95)' : 'rgba(219,234,254,.95)';
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r + (s.pulse * 2.2), 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
      }

      // render player (comet head)
      ctx.fillStyle = dark ? 'rgba(59,130,246,.95)' : 'rgba(37,99,235,.95)';
      ctx.beginPath();
      ctx.arc(player.x, player.y, pr, 0, Math.PI * 2);
      ctx.fill();

      // tiny highlight (scales with size)
      ctx.fillStyle = 'rgba(255,255,255,.7)';
      ctx.beginPath();
      const hr = Math.max(1.2, pr * 0.28);
      ctx.arc(player.x - pr * 0.32, player.y - pr * 0.32, hr, 0, Math.PI * 2);
      ctx.fill();
    }

    requestAnimationFrame(loop);
  })();

  // initialize HUD now
  updateHud();
}

// --- Local time + weather (IP-based, hardened) ---
const localPill = document.getElementById('localPill');
const localPlace = document.getElementById('localPlace');
const localTime = document.getElementById('localTime');
const localWeather = document.getElementById('localWeather');

function wmoToEmoji(code, isDay) {
  const day = isDay === true;

  // Clear / mainly clear
  if (code === 0) return day ? "‚òÄÔ∏è" : "üåô";
  if (code === 1) return day ? "üå§Ô∏è" : "üåô‚òÅÔ∏è";
  if (code === 2) return day ? "‚õÖ" : "‚òÅÔ∏èüåô";
  if (code === 3) return "‚òÅÔ∏è";

  // Fog
  if (code === 45 || code === 48) return "üå´Ô∏è";

  // Drizzle
  if ([51, 53, 55, 56, 57].includes(code)) return day ? "üå¶Ô∏è" : "üåßÔ∏èüåô";

  // Rain
  if ([61, 63, 65, 66, 67, 80, 81, 82].includes(code)) return day ? "üåßÔ∏è" : "üåßÔ∏èüåô";

  // Snow
  if ([71, 73, 75, 77, 85, 86].includes(code)) return "üå®Ô∏è";

  // Thunderstorm
  if ([95, 96, 99].includes(code)) return "‚õàÔ∏è";

  return "üå°Ô∏è";
}


function formatTime(tz) {
  try {
    return new Intl.DateTimeFormat(undefined, {
      hour: '2-digit',
      minute: '2-digit',
      timeZone: tz
    }).format(new Date());
  } catch {
    return new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit' }).format(new Date());
  }
}

async function fetchJson(url, timeoutMs = 6000) {
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), timeoutMs);
  try {
    const res = await fetch(url, { signal: controller.signal, headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } finally {
    clearTimeout(t);
  }
}

function num(v) {
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

async function getGeoBestEffort() {
  // Try multiple providers so adblock / regional blocks don‚Äôt kill you
  // 1) ipapi.co (no key)  :contentReference[oaicite:2]{index=2}
  try {
    const d = await fetchJson("https://ipapi.co/json/");
    const lat = num(d.latitude);
    const lon = num(d.longitude);
    if (lat != null && lon != null) {
      return {
        place: [d.city, d.country_name].filter(Boolean).join(", ") || "Your area",
        tz: d.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone,
        lat, lon
      };
    }
  } catch (e) { /* try next */ }

  // 2) ipinfo.io (no token attempt; may rate limit) :contentReference[oaicite:3]{index=3}
  try {
    const d = await fetchJson("https://ipinfo.io/json");
    const loc = (d.loc || "").split(",");
    const lat = num(loc[0]);
    const lon = num(loc[1]);
    if (lat != null && lon != null) {
      return {
        place: [d.city, d.country].filter(Boolean).join(", ") || "Your area",
        tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
        lat, lon
      };
    }
  } catch (e) { /* try next */ }

  // 3) ipwho.is (often works when others don‚Äôt)
  try {
    const d = await fetchJson("https://ipwho.is/");
    if (d && d.success) {
      const lat = num(d.latitude);
      const lon = num(d.longitude);
      if (lat != null && lon != null) {
        return {
          place: [d.city, d.country].filter(Boolean).join(", ") || "Your area",
          tz: (d.timezone && d.timezone.id) ? d.timezone.id : Intl.DateTimeFormat().resolvedOptions().timeZone,
          lat, lon
        };
      }
    }
  } catch (e) { /* fall through */ }

  return null;
}

async function bootLocalInfo() {
  if (!localPill || !localPlace || !localTime || !localWeather) return;

  // Always show the pill (no silent disappearance)
  localPill.classList.remove('hidden');
  localPill.classList.add('inline-flex');
  localPlace.textContent = "Locating‚Ä¶";
  localTime.textContent = "--:--";
  localWeather.textContent = "--";

  // If you are testing by double-clicking the HTML file (file://),
  // many APIs will block requests. Run a local server instead:
  // python -m http.server 8000

  const CACHE_KEY = "geoWxCache_v2";
  let cached = null;
  try { cached = JSON.parse(localStorage.getItem(CACHE_KEY) || "null"); } catch {}
  const fresh = cached && (Date.now() - cached.t) < (3 * 60 * 60 * 1000); // 3 hours

  let place = "Your area";
  let tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
  let lat = null, lon = null;
  let temp = null, code = null, isDay = null;


  try {
    if (fresh) {
      ({ place, tz, lat, lon, temp, code, isDay } = cached);
    } else {
      const geo = await getGeoBestEffort();
      if (geo) {
        place = geo.place;
        tz = geo.tz || tz;
        lat = geo.lat;
        lon = geo.lon;
      }

      // Weather only if we got coordinates
      if (lat != null && lon != null) {
        // Open-Meteo current weather docs :contentReference[oaicite:4]{index=4}
        const wxUrl =
          `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}` +
          `&current=temperature_2m,weather_code,is_day&temperature_unit=celsius&timezone=auto`;

        const wx = await fetchJson(wxUrl);
        temp = (wx && wx.current) ? num(wx.current.temperature_2m) : null;
        code = (wx && wx.current) ? num(wx.current.weather_code) : null;
        isDay = wx?.current?.is_day === 1;
        tz = (wx && wx.timezone) ? wx.timezone : tz;
      }

      localStorage.setItem(CACHE_KEY, JSON.stringify({ t: Date.now(), place, tz, lat, lon, temp, code, isDay }));
    }
  } catch (e) {
    // Keep showing time even if everything fails
  }

  localPlace.textContent = place;

  const tick = () => { localTime.textContent = formatTime(tz); };
  tick();
  setInterval(tick, 15000);

  if (temp != null) {
    const emoji = (code != null) ? wmoToEmoji(code, isDay) : "üå°Ô∏è";
    localWeather.textContent = `${emoji} ${Math.round(temp)}¬∞C`;
  } else {
    localWeather.textContent = "Weather unavailable";
  }
}

bootLocalInfo();


      console.log('[STUDIO TEST] ‚úì booted');
    });
  </script>
</body>
</html>
